<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>GA Anomalies Monitor</title>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="public/css/gaam.css" />
	</head>
	<body>
		<div class="chart"></div>
		<div id="tooltip"></div>
		<script type="text/javascript" src="public/js/jquery.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.dateformat.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.fillbetween.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.selection.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.symbol.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.time.min.js"></script>
		<script type="text/javascript">
			$.get('/queries', function (data) {
				var date,
					errorData = [],
					markerPosition = 0,
					maxValue = 0,
					pageviewsChart = $('.chart'),
					plot,
					plotData = {
						forecast: [],
						max: [],
						min: [],
						real: []
					},
					queryId = window.location.hash.replace('#', '') || 0;


				data.queries[queryId].data.forEach(function (row) {
					if (row.value > maxValue) {
						maxValue = row.value;
					}
				});
				markerPosition = maxValue / -10;
				data.queries[queryId].data.forEach(function (row) {
					date = (new Date(row.date)).getTime();
					plotData.forecast.push([ date, row.forecast ]);
					plotData.max.push([ date, row.max ]);
					plotData.min.push([ date, row.min ]);
					plotData.real.push([ date, row.value ]);
					if (row.exceeded) {
						errorData.push([ date, markerPosition ]);
					}
				});

				plot = pageviewsChart.plot([
					{
						id: 'minForecast',
						color: '#CFD8DC',
						data: plotData.min,
						lines: {
							fill: false,
							lineWidth: 0,
							show: true
						},
						shadowSize: 0
					},
					{
						id: 'maxForecast',
						color: '#CFD8DC',
						data: plotData.max,
						fillBetween: 'minForecast',
						lines: {
							fill: 0.35,
							lineWidth: 0,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#CFD8DC',
						data: plotData.forecast,
						label: 'Forecast',
						lines: {
							lineWidth: 1.5,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#2196F3',
						data: plotData.real,
						label: 'Value',
						lines: {
							lineWidth: 2,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#F44336',
						data: errorData,
						lines: {
							show: false
						},
						points: {
							radius: 3.5,
							show: true,
							symbol: 'cross'
						},
						shadowSize: 0
					},
					{
						color: '#F44336',
						data: errorData,
						lines: {
							show: false
						},
						points: {
							radius: 3.5,
							show: true,
							symbol: 'cross'
						},
						shadowSize: 0
					}
				], {
					xaxis: {
						font: {
							size: 11,
							family: 'sans-serif',
							color: '#545454'
						},
						mode: 'time',
						position: 'top',
						ticks: 7,
						timezone: 'browser'
					},
					yaxis: {
						min: markerPosition*1.2,
						show: false
					},
					selection: {
						mode: 'x'
					},
					grid: {
						hoverable: true,
						borderWidth: 0
					},
					legend: {
						show: false
					}
				}).data("plot");

				pageviewsChart.on('plotselected', function (event, ranges) {
					$.each(plot.getXAxes(), function(_, axis) {
						var opts = axis.options;
						opts.min = ranges.xaxis.from;
						opts.max = ranges.xaxis.to;
					});
					plot.setupGrid();
					plot.draw();
					plot.clearSelection();
				});
				pageviewsChart.dblclick(function () {
					$.each(plot.getXAxes(), function(_, axis) {
						var opts = axis.options;
						opts.min = plotData.real[0][0];
						opts.max = plotData.real[plotData.real.length - 1][0];
					});
					plot.setupGrid();
					plot.draw();
					plot.clearSelection();
				});
				pageviewsChart.on('plothover', function (event, pos, item) {
					var x, y, label,
						tooltip = $('#tooltip');
					if (item && item.series.label) {
						x = $.format.date(item.datapoint[0], "MM/dd HH:mm");
						y = item.datapoint[1];
						label = item.series.label + ': ' + Math.round(y) + '<br /><small>Time: ' + x + '</small>';

						tooltip.html(label)
							.css({
								top: item.pageY+20,
								left: item.pageX - tooltip.width()/2
							})
							.fadeIn(200);
					} else {
						tooltip.hide();
					}
				});
			});
		</script>
	</body>
</html>