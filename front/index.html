<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>GA Impact Monitor</title>
		<style>
			.pageviews-chart {
				width: 94%;
				height: 150px;
				margin: 3% 3%;
			}
			#tooltip {
				background-color: #000;
				border-radius: 2px;
				color: #eee;
				display: none;
				font-family: sans-serif;
				font-size: 0.8em;
				font-weight: 400;
				opacity: 0.8;
				padding: 0.6em 0.8em;
				position: absolute;
			}
		</style>
	</head>
	<body>
		<div class="pageviews-chart"></div>
		<div id="tooltip"></div>
		<script type="text/javascript" src="public/js/jquery.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.dateformat.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.fillbetween.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.selection.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.symbol.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.time.min.js"></script>
		<script type="text/javascript">
			$.get('/events', function (data) {
				var date,
					errorData = [],
					forecastData = {
						min: [],
						forecast: [],
						max: []
					},
					markerPosition = 0,
					maxValue = 0,
					pageviewsChart = $('.pageviews-chart'),
					plot,
					realData = [],
					queryId = 0;


				data.queries[queryId].data.real.forEach(function (row) {
					date = new Date(row.date);
					realData.push([ date.getTime(), row.value ]);
					if (row.value > maxValue) {
						maxValue = row.value;
					}
				});
				markerPosition = maxValue / -5;
				data.queries[queryId].data.forecast.forEach(function (row) {
					date = new Date(row.date);
					forecastData.min.push([ date.getTime(), row.value.min ]);
					forecastData.forecast.push([ date.getTime(), row.value.forecast ]);
					forecastData.max.push([ date.getTime(), row.value.max ]);
					if (row.exceeded) {
						errorData.push([ date.getTime(), markerPosition ]);
					}
				});

				plot = pageviewsChart.plot([
					{
						id: 'minForecast',
						color: '#CFD8DC',
						data: forecastData.min,
						lines: {
							fill: false,
							lineWidth: 0,
							show: true
						},
						shadowSize: 0
					},
					{
						id: 'maxForecast',
						color: '#CFD8DC',
						data: forecastData.max,
						fillBetween: 'minForecast',
						lines: {
							fill: 0.35,
							lineWidth: 0,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#CFD8DC',
						data: forecastData.forecast,
						label: 'Forecast',
						lines: {
							lineWidth: 1.5,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#2196F3',
						data: realData,
						label: 'Value',
						lines: {
							lineWidth: 2,
							show: true
						},
						shadowSize: 0
					},
					{
						color: '#F44336',
						data: errorData,
						lines: {
							show: false
						},
						points: {
							radius: 3.5,
							show: true,
							symbol: 'cross'
						},
						shadowSize: 0
					},
					{
						color: '#F44336',
						data: errorData,
						lines: {
							show: false
						},
						points: {
							radius: 3.5,
							show: true,
							symbol: 'cross'
						},
						shadowSize: 0
					}
				], {
					xaxis: {
						font: {
							size: 11,
							family: 'sans-serif',
							color: '#545454'
						},
						mode: 'time',
						position: 'top',
						ticks: 7,
						timezone: 'browser'
					},
					yaxis: {
						min: markerPosition*2,
						show: false
					},
					selection: {
						mode: 'x'
					},
					grid: {
						hoverable: true,
						borderWidth: 0
					},
					legend: {
						show: false
					}
				}).data("plot");

				pageviewsChart.on('plotselected', function (event, ranges) {
					$.each(plot.getXAxes(), function(_, axis) {
						var opts = axis.options;
						opts.min = ranges.xaxis.from;
						opts.max = ranges.xaxis.to;
					});
					plot.setupGrid();
					plot.draw();
					plot.clearSelection();
				});
				pageviewsChart.dblclick(function () {
					$.each(plot.getXAxes(), function(_, axis) {
						var opts = axis.options;
						opts.min = realData[0][0];
						opts.max = realData[realData.length - 1][0];
					});
					plot.setupGrid();
					plot.draw();
					plot.clearSelection();
				});
				pageviewsChart.on('plothover', function (event, pos, item) {
					var x, y, label,
						tooltip = $('#tooltip');
					if (item && item.series.label) {
						x = $.format.date(item.datapoint[0], "MM/dd HH:mm");
						y = item.datapoint[1];
						label = item.series.label + ': ' + Math.round(y) + '<br /><small>Time: ' + x + '</small>';

						tooltip.html(label)
							.css({
								top: item.pageY+20,
								left: item.pageX - tooltip.width()/2
							})
							.fadeIn(200);
					} else {
						tooltip.hide();
					}
				});
			});
		</script>
	</body>
</html>